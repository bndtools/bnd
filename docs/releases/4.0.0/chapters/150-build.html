<!DOCTYPE html>
<html lang="en" ng-app="jpm">

	<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="/releases/4.0.0/css/style.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="/js/releases.js"></script>
<!-- Begin Jekyll SEO tag v2.4.0 -->
<title>Build</title>
<meta name="generator" content="Jekyll v3.7.3" />
<meta property="og:title" content="Build" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This chapter lays out the rules of the file system for bnd projects. It discusses the workspace layout and the projects layout as well as the properties." />
<meta property="og:description" content="This chapter lays out the rules of the file system for bnd projects. It discusses the workspace layout and the projects layout as well as the properties." />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-10-12T20:27:56-04:00" />
<script type="application/ld+json">
{"datePublished":"2019-10-12T20:27:56-04:00","description":"This chapter lays out the rules of the file system for bnd projects. It discusses the workspace layout and the projects layout as well as the properties.","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"/releases/4.0.0/chapters/150-build.html"},"url":"/releases/4.0.0/chapters/150-build.html","headline":"Build","dateModified":"2019-10-12T20:27:56-04:00","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

















		<style>
			 body {
				counter-reset: h1 8;
			}
		</style>
























































</head>


<body>


<ul class="container12 menu-bar">
	<li span=11><a class=menu-link href="/releases/4.0.0/"><img
			class=menu-logo src='/releases/4.0.0/img/bnd-80x40-white.png'></a>
			<a href="/releases/4.0.0/chapters/110-introduction.html">Intro
			</a><a href="/releases/4.0.0/chapters/800-headers.html">Headers
			</a><a href="/releases/4.0.0/chapters/820-instructions.html">Instructions
			</a><a href="/releases/4.0.0/chapters/850-macros.html">Macros
			</a><div class="releases"><button class="dropbtn">4.0.0</button><div class="dropdown-content"></div></div>

	<li class=menu-link span=1>
			<a href="https://github.com/bndtools/bnd" target="_"><img
	style="position:absolute;top:0;right:0;margin:0;padding:0;z-index:100"
	src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67"
	alt="Fork me on GitHub"
	data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>
</ul>




	<ul class=container12>
		<li span=3>
			<div>
			<ul class="side-nav">


			<li><a href="/releases/4.0.0/chapters/100-release.html">Release</a>



			<li><a href="/releases/4.0.0/chapters/110-introduction.html">Introduction</a>



			<li><a href="/releases/4.0.0/chapters/120-install.html">How to install bnd</a>



			<li><a href="/releases/4.0.0/chapters/123-tour-workspace.html">Guided Tour</a>



			<li><a href="/releases/4.0.0/chapters/125-tour-features.html">Guided Tour Workspace & Projects</a>



			<li><a href="/releases/4.0.0/chapters/130-concepts.html">Concepts</a>



			<li><a href="/releases/4.0.0/chapters/140-best-practices.html">Best practices</a>



			<li class=selected>Build



			<li><a href="/releases/4.0.0/chapters/160-jars.html">Generating JARs</a>



			<li><a href="/releases/4.0.0/chapters/170-versioning.html">Versioning</a>



			<li><a href="/releases/4.0.0/chapters/180-baselining.html">Baselining</a>



			<li><a href="/releases/4.0.0/chapters/200-components.html">Service Components</a>



			<li><a href="/releases/4.0.0/chapters/210-metatype.html">Metatype</a>



			<li><a href="/releases/4.0.0/chapters/220-contracts.html">Contracts</a>



			<li><a href="/releases/4.0.0/chapters/230-manifest-annotations.html">Manifest Annotations</a>



			<li><a href="/releases/4.0.0/chapters/250-resolving.html">Resolving Dependencies</a>



			<li><a href="/releases/4.0.0/chapters/300-launching.html">Launching</a>



			<li><a href="/releases/4.0.0/chapters/310-testing.html">Testing</a>



			<li><a href="/releases/4.0.0/chapters/320-packaging.html">Packaging Applications</a>



			<li><a href="/releases/4.0.0/chapters/390-wrapping.html">Wrapping Libraries to OSGi Bundles</a>



			<li><a href="/releases/4.0.0/chapters/400-commandline.html">From the command line</a>



			<li><a href="/releases/4.0.0/chapters/600-developer.html">For Developers</a>



			<li><a href="/releases/4.0.0/chapters/610-plugin.html">Plugins</a>



			<li><a href="/releases/4.0.0/chapters/700-tools.html">Tools bound to bnd</a>



			<li><a href="/releases/4.0.0/chapters/790-format.html">File Format</a>



			<li><a href="/releases/4.0.0/chapters/800-headers.html">Header Reference</a>



			<li><a href="/releases/4.0.0/chapters/820-instructions.html">Instruction</a>



			<li><a href="/releases/4.0.0/chapters/825-instructions-ref.html">Instruction Index</a>



			<li><a href="/releases/4.0.0/chapters/850-macros.html">Macro Reference</a>



			<li><a href="/releases/4.0.0/chapters/860-commands.html">Command Reference</a>



			<li><a href="/releases/4.0.0/chapters/870-plugins.html">Plugins Reference</a>



			<li><a href="/releases/4.0.0/chapters/880-settings.html">Settings</a>



			<li><a href="/releases/4.0.0/chapters/900-errors.html">Errors</a>



			<li><a href="/releases/4.0.0/chapters/910-warnings.html">Warnings</a>



			<li><a href="/releases/4.0.0/chapters/920-faq.html">Frequently Asked Questions</a>


</ul>

			<div class=enroute><a href="https://enroute.osgi.org">Supported by OSGi enRoute <img src="/releases/4.0.0/img/EnRouteIcon_CMYK.png"></a></div>
			</div>

		<li span=9>
			<div class=notes-margin>
				<h1> Build</h1>
				<p>This chapter lays out the rules of the file system for bnd projects. It discusses the workspace layout and the projects layout as well as the properties.</p>

<h2 id="workspace">Workspace</h2>
<p>A Workspace is a single directory with all its sub-directories and their files, similar to a git workspace. The core idea of the workspace is that it is easy to move around, that is, it allows the use of relative file names. It also prevents a lot of potential problems that occur when you allow projects to be anywhere on the file system. KISS!</p>

<p>Workspaces should be named according to the bundle symbolic names of its projects. Using such a naming strategy will simplify finding the correct namespace given a bundle symbolic name.</p>

<p>A bndlib workspace is a <em>valid</em> workspace when it contains a <code class="highlighter-rouge">cnf</code> file. If this is a text file, its content is read and interpreted as a path to the <code class="highlighter-rouge">cnf</code> directory (which can again be a path to a cnf directory, ad infinitum). The retrieved path is retrieved and trimmed after which it is resolved relative to its parent directory.</p>

<p>However, the advised model is to use a directory with a <code class="highlighter-rouge">cnf/build.bnd</code> file. The purpose of the <code class="highlighter-rouge">cnf</code> directory is to provide a place for shared information. Though this includes bndlib setup information, it also can be used to define for example shared licensing, copyright, and vendor headers for your organization.</p>

<p>The <code class="highlighter-rouge">cnf</code> directory can have an <code class="highlighter-rouge">ext</code> directory, this directory contains any extensions to bnd.</p>

<p>To cache some intermediate files, bndlib will create a <code class="highlighter-rouge">cnf/cache/</code> directory, this file should not be under source control. E.g. in Git it should be defined in the <code class="highlighter-rouge">.gitignore</code> file.</p>

<p>The root of the workspace is generally used to hold other files. For example the <code class="highlighter-rouge">.git</code> directory for Git, or gradle and ant files for continuous integration. However, designers that add functionality to the workspace should strive to minimize the clutter in the root. For example, the bnd gradle support adds a few files to the root but these link to a <code class="highlighter-rouge">cnf/gradle</code> directory for their actual content.</p>

<p>Other directories in the workspace represent <em>projects</em>. The name of the project is the bundle symbolic name of the bundle that it produces (or the prefix of the bundle symbolic name when it produces multiple bundles).</p>

<p>Overall, this gives us the following layout for a workspace:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>com.acme.prime/                     workspace
  cnf/                              configuration/setup
    ext/                            extensions
      maven.bnd                     maven setup extension
    build.bnd                       organization setup
    plugins/                        directory for plugins
    cache/                          bnd cache directory, should not be saved in an scm
  com.acme.prime.speaker/           project directory
</code></pre></div></div>

<h3 id="workspace-properties">Workspace Properties</h3>

<p>Properties are used for headers, macros, and instructions in bndlib, they are quite fundamental. To simplify maintenance, bndlib provides an elaborate mechanism to provide these properties from different places and <em>inherit</em> them. The workspace resides at the top of this inheritance chain (ok, after the built-in defaults).</p>

<p>When a workspace is created, it will first read in the properties in the <code class="highlighter-rouge">.bnd</code> files in the <code class="highlighter-rouge">cnf/ext</code> directory. These are called the <em>extension files</em> since they in general setup plugins and other extensions. The order in which they are read is the lexical sorting order of their file names.</p>

<h3 id="extension-files">Extension Files</h3>

<p>Extension files allow you to separate configuration concerns. Its primary purpose is to allow third party extensions. These extensions can then put their properties in one place. The contents of these files should therefore not be touched so that a new version can override them. Each extension file is read as a bnd file, this means that full power of bndlib is available. The bnd command line tool has facilities to add and remove files from this directory.</p>

<p>For example, the Maven plugin that is built-in to bndlib has an extension file called maven.bnd which looks as follows:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#
# Plugin maven setup
#
-plugin.maven = aQute.bnd.plugin.maven.MavenPlugin


#
# Change disk layout to fit maven
#

-outputmask = ${@bsn}-${versionmask;===S;${@version}}.jar
src=src/main/java
bin=target/classes
testsrc=src/test/java
testbin=target/test-classes
target-dir=target
</code></pre></div></div>

<p>We will not explain this plugin here (you can find it in the plugin sections), it only illustrates here how it is possible to setup the environment for a specific optional functionality like a plugin.</p>

<p>If you create local extension files then you should use a prefix to identify this is your file, like:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>com.acme-local.bnd
</code></pre></div></div>

<p>It is possible to use file links to maintain these files in one place when you have many workspaces.</p>

<h3 id="local-customizations">Local customizations</h3>

<p>After reading the extension files, bndlib reads the <code class="highlighter-rouge">cnf/build.bnd</code> file, this file is supposed to hold the organization specific properties. Out of the box, this file comes empty, ready to be filled by you.</p>

<h3 id="workspace-plugins">Workspace Plugins</h3>

<p>A <em>plugin</em> is a piece of code that runs inside bnd. The workspace provides a number of standard built-in plugins like an Executor, a Randum number generator, itself, etc. Additional plugins can be added with the <code class="highlighter-rouge">-plugin.*</code> instructions.</p>

<h2 id="project-properties">Project Properties</h2>
<p>There are a number of built in properties that are set by bnd:</p>

<table>
  <thead>
    <tr>
      <th>Property name</th>
      <th style="text-align: left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">project</code></td>
      <td style="text-align: left">Name of the project. This is the name of the bnd file without</td>
    </tr>
    <tr>
      <td> </td>
      <td style="text-align: left">the .bnd extension. If this name is bnd.bnd, then the directory</td>
    </tr>
    <tr>
      <td> </td>
      <td style="text-align: left">name is used.</td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">project.file</code></td>
      <td style="text-align: left">Absolute path of the main bnd file.</td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">project.name</code></td>
      <td style="text-align: left">Just the name part of the file path</td>
    </tr>
  </tbody>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">project.dir</code></td>
      <td style="text-align: left">The absolute path of the directory in which the bnd file resides.</td>
    </tr>
  </tbody>
</table>

<h2 id="run-instructions">Run instructions</h2>
<p>Run instructions are used to start OSGi tests and OSGi runs.</p>

<p>(:cellnr:)<code class="highlighter-rouge">-runbundles</code></p>
<td>`LIST SPEC`</td>
<td>Additional bundles that will be installed and started when the framework is launched. This property is normally part of the project's `bnd.bnd` file.</td>

<p>(:cellnr:)<code class="highlighter-rouge">-runvm</code></p>
<td>`PROPERTIES`</td>
<td>Properties given to the VM before launching. This property is normally set in the cnf/build.bnd file and only in rare cases overridden in the bnd.bnd file.</td>

<p>(:cellnr:)<code class="highlighter-rouge">-runproperties</code></p>
<td>`PROPERTIES`</td>
<td>Properties given to the framework when launching. Usually project specific.</td>

<p>(:cellnr:)<code class="highlighter-rouge">-runsystempackages</code></p>
<td>`PACKAGES`</td>
<td>A declaration like Import-Package that specifies additional system packages to import from the class path. Usually given in the cnf/build.bnd file.</td>

<p>(:cellnr:)<code class="highlighter-rouge">-runpath</code></p>
<td>`LIST SPEC`</td>
<td>A path description of artifacts that must be on the classpath of the to be launched framework.  Usually given in the cnf/build.bnd file. This path should contain the framework. Any packages that a bundle on the -runpath should specify should be listed in the `export` attribute.</td>

<p>(:cellnr:)<code class="highlighter-rouge">-runtrace</code></p>
<td>`true|'''false'''`</td>
<td>Trace the startup of the framework to the console. Usually used during testing and development so project specific.</td>

<p>(:cellnr:)<code class="highlighter-rouge">-runframework</code></p>
<td>`none|'''services'''`</td>
<td>`NONE` indicates that a mini built in framework should be used. `SERVICES` indicates that the `META-INF/services` model must be followed for the `org.osgi.framework.launch.FrameworkFactory` class. Project specific.</td>

<p>(:cellnr:)<code class="highlighter-rouge">-testpath</code></p>
<td>`LIST SPEC`</td>
<td>A path used to specify the test plugin</td>

<p>(:tableend:)</p>

<h2 id="launching">Launching</h2>
<p>Launching is needed when the project’s <code class="highlighter-rouge">run</code> action or <code class="highlighter-rouge">test</code> action is executed. The project creates a Project Launcher. A Project Launcher must launch a new VM and set up this VM correctly. The VM is launched with the following information.</p>

<ul>
  <li><code class="highlighter-rouge">java</code> - The command to launch a new VM is bu default <code class="highlighter-rouge">java</code>. However, this can be overridden by setting a property called <code class="highlighter-rouge">java</code>.</li>
  <li><code class="highlighter-rouge">classpath</code> - The classpath set for the VM is derived from the <code class="highlighter-rouge">-runpath</code> property. Notice that this is supposed to contain the JAR with the framework. The <code class="highlighter-rouge">-runpath</code> requires bundle symbolic names for the JAR and an optional version range. bnd will use the latest version in the repository. Any packages that should be exported by the system bundle should have an export attribute containing the exported packages, like `junit.osgi;version=3.8;export=”junit.framework;version=3.8,junit.misc;version=3.8”.</li>
  <li><code class="highlighter-rouge">vm options</code> - These options can be set in the <code class="highlighter-rouge">-runvm</code> property. They are usually in the form of <code class="highlighter-rouge">-Dxya=15</code> or <code class="highlighter-rouge">-X:agent=bla</code>. Options should be separated by commas.</li>
  <li><code class="highlighter-rouge">main</code> - The class implementing the main type is defined by the launcher plugin.</li>
</ul>

<p>And example of a launcher set is:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-runvm:   -Xmn100M, -Xms500M, -Xmx500M
-runpath: \
	org.apache.felix.framework; version=3.0, \
	junit.osgi;export="junit.framework;version=3.8"
-runtrace: true
-runproperties: launch=42, trace.xyz=true
-runbundles: org.apache.felix.configadmin,\
	org.apache.felix.log,\
	org.apache.felix.scr,\
	org.apache.felix.http.jetty,\
	org.apache.felix.metatype,\
	org.apache.felix.webconsole
</code></pre></div></div>

<p>Debugging launching is greatly simplified with the -runtrace property set to true. This provides a lot of feedback what the launcher is doing.</p>

<p>###Access to arguments
When the launcher is ready it will register itself as a service with the following properties:</p>

<table>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">launcher.arguments</code></td>
      <td>The command line arguments</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">launcher.ready</code></td>
      <td>Indicating the launcher is read</td>
    </tr>
  </tbody>
</table>

<p>###Access to main thread
In certain cases it is necessary to grab the main thread after launching. The default launcher will launch all the bundles and then wait for any of those bundles to register a Runnable service with a service property <code class="highlighter-rouge">main.thread=true</code>. If such  service is registered, the launcher will call the run method and exit when this method returns.</p>

<p>###Timeout
The launcher will timeout after an hour. There is currently no way to override this timeout.</p>

<p>###Mini Framework
The bnd launcher contains a mini framework that implements the bare bones of an OSGi framework. The purpose of this mini framework is to allow tests and runs that want to launch their own framework. A launch that wants to take advantage of this can launch with the following property:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-runframework: none
</code></pre></div></div>

<p>###Ant
In ant, the following task provides the run facility.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;target name="run" depends="compile"&gt;
	&lt;bnd command="run" exceptions="true" basedir="${project}" /&gt;
&lt;/target&gt;
</code></pre></div></div>

<p>These targets provide commands for <code class="highlighter-rouge">ant run</code>.</p>

<h2 id="testing">Testing</h2>
<p>Testing is in principle the same as launching, it actually uses the launcher. Testing commences with the <code class="highlighter-rouge">test</code> action in the project. This creates a Project Tester. bnd carries a default Project Tester but this can be overridden.</p>

<p>The basic model of the default Project Tester plugin is to look for bundles that have a <code class="highlighter-rouge">Test-Cases</code> manifest header after launching. The value of this header is a comma separated list of JUnit test case class names. For example:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Test-Cases: test.LaunchTest, test.OtherTest
</code></pre></div></div>

<p>Maintaining this list can be cumbersome and for that reason the <code class="highlighter-rouge">${classes}</code> macro can be used to calculate its contents:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Test-Cases : ${classes;extending;junit.framework.TestCase;concrete}
</code></pre></div></div>

<p>See <a href="../macros/classes.html">classes macro</a> for more information.</p>

<p>###Ant</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;target name="test" depends="compile"&gt;
	&lt;bnd command="test" exceptions="true" basedir="${project}" /&gt;
&lt;/target&gt;
</code></pre></div></div>

<h2 id="overriding-the-plugins">Overriding the plugins</h2>
<p>Both the Project launcher and Project Tester are plugins. Defaults are provided by bnd itself (bnd carries a mini cache repo that is expanded in the cnf director), it is possible to add new launchers and testers as needed.</p>

<p>Plugins are found on the -runpath or the -testpath properties respectively. bnd will look for an appropriate manifest header. The header has a class name as value. It will then instantiate the class and use as launcher/tester. The classes must extend an abstract base class. Each plugin has access to the Project object, containing all the details of the project.</p>

<table>
  <tbody>
    <tr>
      <td>Plugin</td>
      <td>Manifest header</td>
      <td>Base Class</td>
      <td>Where</td>
    </tr>
    <tr>
      <td>Project Launcher</td>
      <td>Launcher-Plugin</td>
      <td>ProjectLauncher</td>
      <td>-runpath</td>
    </tr>
    <tr>
      <td>Project Test</td>
      <td>Tester-Plugin</td>
      <td>ProjectLauncher</td>
      <td>-testpath</td>
    </tr>
  </tbody>
</table>

<p>The plugin gets complete control and can implement many different strategies.</p>

			</div>
	</ul>


<nav class=next-prev>
	<a href='/releases/4.0.0/chapters/140-best-practices.html'></a> <a href='/releases/4.0.0/chapters/160-jars.html'></a>
</nav>
<footer class="container12" style="border-top: 1px solid black;padding:10px 0">
	<ul span=12 row>
		<li span=3>
			<ul>
				<li><a href="/releases/4.0.0/contact.html">Contact</a>
			</ul>
		<li span=3>
			<ul>
				<li><a href="/releases/4.0.0/">Developers</a>
			</ul>
		<li span=3>
			<ul>
				<li><a href="/releases/4.0.0/">More</a>
			</ul>
	</ul>
</footer>

</body>
</html>
