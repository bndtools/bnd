<!DOCTYPE html>
<html lang="en" ng-app="jpm">

	<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="/releases/5.1.0/css/style.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="/js/releases.js"></script>
<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Metatype</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Metatype" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The OSGi Metatype specification provides a language to describe configuration information in an XML file. However, XML is cumbersome to use and eXtreMeLy error prone, and refactoring often finds it hard to change references in XML text files. Especially with DS components managing the relations can be complex, see [[Components]]" />
<meta property="og:description" content="The OSGi Metatype specification provides a language to describe configuration information in an XML file. However, XML is cumbersome to use and eXtreMeLy error prone, and refactoring often finds it hard to change references in XML text files. Especially with DS components managing the relations can be complex, see [[Components]]" />
<script type="application/ld+json">
{"url":"/releases/5.1.0/chapters/210-metatype.html","headline":"Metatype","description":"The OSGi Metatype specification provides a language to describe configuration information in an XML file. However, XML is cumbersome to use and eXtreMeLy error prone, and refactoring often finds it hard to change references in XML text files. Especially with DS components managing the relations can be complex, see [[Components]]","@type":"WebPage","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


	

	

	

	

	

	

	

	

	

	

	

	

	
		<style>
			 body {
				counter-reset: h1 13;
			}
		</style>
	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

</head>


<body>

	
<ul class="container12 menu-bar">
	<li span=11><a class=menu-link href="/releases/5.1.0/"><img
			class=menu-logo src="/releases/5.1.0/img/bnd-80x40-white.png"></a>
			<a href="/releases/5.1.0/chapters/110-introduction.html">Intro
			</a><a href="/releases/5.1.0/chapters/800-headers.html">Headers
			</a><a href="/releases/5.1.0/chapters/825-instructions-ref.html">Instructions
			</a><a href="/releases/5.1.0/chapters/855-macros-ref.html">Macros
			</a><a href="/releases/5.1.0/chapters/400-commands.html">Commands
			</a><div class="releases"><button class="dropbtn">5.1.0</button><div class="dropdown-content"></div></div>
	<li class=menu-link span=1>
			<a href="https://github.com/bndtools/bnd" target="_"><img
	style="position:absolute;top:0;right:0;margin:0;padding:0;z-index:100"
	src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67"
	alt="Fork me on GitHub"
	data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>
</ul>


					

	<ul class=container12>
		<li span=3>
			<div>
			<ul class="side-nav">
	
		
			<li><a href="/releases/5.1.0/chapters/110-introduction.html">Introduction</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/120-install.html">How to install bnd</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/123-tour-workspace.html">Guided Tour</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/125-tour-features.html">Guided Tour Workspace & Projects</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/130-concepts.html">Concepts</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/140-best-practices.html">Best practices</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/150-build.html">Build</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/155-project-setup.html">Project Setup</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/160-jars.html">Generating JARs</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/170-versioning.html">Versioning</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/180-baselining.html">Baselining</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/200-components.html">Service Components</a>
	  	
  	
		
			<li class=selected>Metatype
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/220-contracts.html">Contracts</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/230-manifest-annotations.html">Bundle Annotations</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/235-accessor-properties.html">Accessor Properties</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/240-spi-annotations.html">SPI Annotations</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/250-resolving.html">Resolving Dependencies</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/300-launching.html">Launching</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/305-startlevels.html">Startlevels</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/310-testing.html">Testing</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/315-launchpad-testing.html">Testing with Launchpad</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/320-packaging.html">Packaging Applications</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/330-jpms.html">JPMS Libraries</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/390-wrapping.html">Wrapping Libraries to OSGi Bundles</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/395-generating-documentation.html">Generating Documentation</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/400-commands.html">Commands</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/600-developer.html">For Developers</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/650-windows.html">Tips for Windows users</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/700-tools.html">Tools bound to bnd</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/800-headers.html">Headers</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/820-instructions.html">Instruction Reference</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/825-instructions-ref.html">Instruction Index</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/850-macros.html">Macro Reference</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/855-macros-ref.html">Macro Index</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/870-plugins.html">Plugins</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/875-external-plugins.html">External Plugins</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/880-settings.html">Settings</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/900-errors.html">Errors</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/910-warnings.html">Warnings</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/920-faq.html">Frequently Asked Questions</a>
	  	
  	
</ul>

			</div>
			
		<li span=9>
			<div class=notes-margin>
				<h1> Metatype</h1>
				<p>The OSGi Metatype specification provides a language to describe configuration information in an XML file. However, XML is cumbersome to use and eXtreMeLy error prone, and refactoring often finds it hard to change references in XML text files. Especially with DS components managing the relations can be complex, see [[Components]]</p>

<p>For this reason, bnd provides annotations to define the XML based on a ‘‘configuration’’ interface. For example, the following interface defines a simple metatype:</p>

<p>package com.acme;
  import aQute.bnd.annotation.metatype.*;</p>

<p>@Meta.OCD interface Config {
    int port();
  }</p>

<p>To turn this into an XML file, the bnd file must contain:</p>

<p>-metatype: *</p>

<p>The wild card will search through the whole bundle but it is possible to limit this to a restricted set of packages to speed up the processing. For example:</p>

<p>-metatype: <em>Metatype</em>, com.libs.metatypes</p>

<p>If the previous <code class="highlighter-rouge">Config</code> interface is present in the output, the output will also contain an XML file at <code class="highlighter-rouge">OSGI-INF/metatype/com.acme.Config.xml</code>. This file will look as follows:</p>

<metatype:MetaData xmlns:metatype="http://www.osgi.org/xmlns/metatype/v1.1.0">
    <OCD name="Config" id="aQute.metatype.samples.Config" localization="aQute.metatype.samples.Config">
      <AD name="Port" id="port" cardinality="0" required="true" type="Integer" />
    </OCD>
    <Designate pid="aQute.metatype.samples.Config">
      <object ocdref="aQute.metatype.samples.Config" />
    </Designate>
  </metatype:MetaData>

<p>bnd leverages the rich type information the Java class files contain. It inspects the returns types and from this it automatically calculates the AD type as well as the cardinality. For example, a method like:</p>

<p>List<Integer> ints()</Integer></p>

<p>Provides an AD of:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;AD 
  name='Ints' 
  id='ints' 
  cardinality='-2147483648' 
  required='true' 
  type='Integer'/&gt;
</code></pre></div></div>

<h2 id="naming">Naming</h2>
<p>bnd attempts to make the names of the OCD and AD human readable by un-camel-casing the id. This means that it uses the upper cases in the id to decide where to use spaces. It also attempts to replace ‘_’ characters with spaces and removes ‘$’. If the result is not what is wanted, the name can always be explicitly set with the AD.name() field.</p>

<p>The id of the properties is by default derived from the method name. The name space of methods is restricted by the Java language both in character set as well as by the reserved keywords. Therefore, bnd mangles the name of the method to allow the method name to be adapted to common practices in proeprty names.</p>

<ul>
  <li>’$’ is removed from the name unless it is followed by another ‘$’, in that case it is a single ‘$’. This can be used to use Java keywords as a name. For example, <code class="highlighter-rouge">$new</code> maps to the <code class="highlighter-rouge">new</code> name. To make the name <code class="highlighter-rouge">$x</code>, use a method with the name <code class="highlighter-rouge">$$x</code>.</li>
  <li>‘<em>’ is replaced with ‘.’ unless it is followed by another ‘</em>’, in that case it becomes a single ‘_’. This is useful for dotted names (<code class="highlighter-rouge">a.b.c</code> comes from <code class="highlighter-rouge">a_b_c</code>) and to indicate private properties, that is properties that start with a ‘.’. For example, <code class="highlighter-rouge">_secret</code> maps to <code class="highlighter-rouge">.secret</code> and this will be a property that is not registered as a service.</li>
</ul>

<p>For example:</p>

<p>@OCD
  interface Config {
    String _password(); // .password - will not be registered as a service
    String $new();      // new - keyword
  }</p>

<h2 id="metaocd">@Meta.OCD</h2>
<p>The OCD annotation is necessary to know that an interface is a Metatype interface. It should be used preferably without any parameters (they all have good defaults). However, each default is possible to override. The following table discusses the fields:</p>

<table>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">name</code></td>
      <td>String</td>
      <td>A human readable name of the component, can be localized if it starts with a % sign. The default is a string derived from the id where _, $, or camel casing is used to provide spaces.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">id</code></td>
      <td>String</td>
      <td>The id of the OCD, this will also be used for the pid of the Designate element.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">localization</code></td>
      <td>String</td>
      <td>The localization id of the metatype. This refers to a properties file in the OSGI-INF/i10l/<localization>.properties file that can be augmented with locale information.</localization></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">description</code></td>
      <td>String</td>
      <td>A human readable description that can be localized. Default is empty.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">factory</code></td>
      <td>String</td>
      <td>Will treat this OCD as intended to be for a factory configuration. The default is <code class="highlighter-rouge">false</code></td>
    </tr>
  </tbody>
</table>

<h2 id="metaad">@Meta.AD</h2>
<p>The <code class="highlighter-rouge">AD</code> is an optional annotation on methods of a OCD interface. The annotation makes it possible to override the defaults and provide extra information.</p>

<table>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">name</code></td>
      <td>String</td>
      <td>A human readable name of the attribute, can be localized if it starts with a % sign. The default is a string derived from the method name where _, $, or camel casing is used to provide spaces.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">id</code></td>
      <td>String</td>
      <td>The id of the attribute. By default this is the name of the method</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">description</code></td>
      <td>String</td>
      <td>A human readable description that can be localized. Default is empty.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">type</code></td>
      <td>String</td>
      <td>The type of the attribute. This must be one of the types defined in the Metatype specification. By default the type will be derived from the return type of the method. If no applicable type can be found then the <code class="highlighter-rouge">String</code> type is used as final default.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">cardinality</code></td>
      <td>int</td>
      <td>The cardinality of the attribute. If this is negative its absolute indicates maximum number of elements in a Vector. If it is positive it indicates the maximum number of values in an array. Zero indicates a scalar. If not provided, bnd will calculate the cardinality based on the return type. Collections will have a negative large value and arrays have a positive large value.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">min</code></td>
      <td>String</td>
      <td>The minimum value allowed for this attribute. There is no default.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">max</code></td>
      <td>String</td>
      <td>The maximum value allowed for this attribute. There is no default.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">deflt</code></td>
      <td>String</td>
      <td>The default initial value. The default for this is an empty String</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">required</code></td>
      <td>boolean</td>
      <td>Indicates if this attribute is required. The default is that attributes are required.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">optionLabels</code></td>
      <td>String[]</td>
      <td>Labels for any values specified in <code class="highlighter-rouge">optionValues</code>. The default value is unset if there are no optionValues are defined. If these are defined, then the labels are calculated from the values by making _, $ into spaces and providing spaces between camel cased words in the values.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">optionValues</code></td>
      <td>String[]</td>
      <td>Optional values. If this field is not set and the return type is an enum type then the values are calculated from the enum members.</td>
    </tr>
  </tbody>
</table>

<h2 id="runtime-conversions">Runtime conversions</h2>
<p>The type support the OSGi Metatype specification is limited to the primitives and strings. So what happens when you use another type? During the build phase, bnd will revert to a ‘String’ Metatype type. This means that those special types are going to be strings in the dictionary. However, the aQute.bnd.annotation.metatype package contains a helper class that simplifies the usage of properties in runtime. It has a @createConfigurable(Class<T> c, Map<?,?> props)`. This method returns an object that implements the given configuration interface. The implementation of these methods uses the properties to provide a value. That is, calling the method abc() on this interface will attempt to find the property "abc". It will then use the actual return type of the method to do conversion from the type in the properties to the return type. This takes generic information into account when present.</T></p>

<p>For example:</p>

<p>@Meta.OCD
  interface Config {
    URI[] uris();
  }</p>

<p>public void updated( Map&lt;String,Object&gt; props) {
    config = Configurable.createConfigurable(Config.class,props);
    for ( URI URI : config.uris() ) {
      …
    }
  }</p>

<p>The Metatype specification does not support URIs, so how does this work? Lets first look at the AD:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;AD 
 name='uris' 
 id='uris' 
 cardinality='2147483647' 
 required='true' 
 type='String'/&gt;
</code></pre></div></div>

<p>Any editor will therefore put an array of strings (String[]) in the properties. When the proxy gets the string, it will therefore have to convert from the String[] -&gt; URI[]. In this case, the URI has a String constructor and is used to do the conversion from String to URI. The converter can handle general array to collection, collection to array, and as indicated, any conversion to an object that has a String constructor.</p>

<p>For convenience there are a number of built int conversions provided that cannot leverage the String constructor:</p>

<ul>
  <li>Pattern - Allows regular expression to be set</li>
  <li>Class&lt;?&gt; - Tries to load a class through the class loader of the configuration interface</li>
  <li>boolean - Converts wrappers and primitive boolean to 0 (false) or non-0 (true) and vice versa.</li>
  <li>Numbers - Converts any known Number subclass to another Number subclass, including the primitive types.</li>
  <li>Enums - If the return type is an enum, it will use the <code class="highlighter-rouge">valueOf</code> method to get an instance.</li>
</ul>

<h2 id="example">Example</h2>
<p>The following example shows a very simple metatype configuration interface:</p>

<p>package aQute.metatype.samples;
  import aQute.bnd.annotation.metatype.Meta.*;
  @OCD
  public interface Config {
    int port();
  }</p>

<p>If the bnd.bnd file contains:</p>

<p>-metatype: *</p>

<p>Then bnd will detect this class as a Metatype and it generates the following XML in `OSGi-INF/metatype/aQute.metatype.samples.Config.xml</p>

<p><?xml version='1.0'?></p>
<metatype:MetaData xmlns:metatype="http://www.osgi.org/xmlns/metatype/v1.1.0">
    <OCD name="Config" id="aQute.metatype.samples.Config" localization="aQute.metatype.samples.Config">
      <AD name="Port" id="port" cardinality="0" required="true" type="Integer" />
    </OCD>
    <Designate pid="aQute.metatype.samples.Config">
      <object ocdref="aQute.metatype.samples.Config" />
    </Designate>
  </metatype:MetaData>

<p>As usual, XML does an outstanding job in obfuscating the interesting parts. If you’re using the Apache Felix Webconsole (and if not, why not?) then you can edit this metatype on the web:</p>

<p>%width=500px% http://www.aqute.biz/uploads/Bnd/webconsole.png</p>

<p>This metatype can now be used in a simple example that prints the port number:</p>

<p>package aQute.metatype.samples;
  import java.util.<em>;
  import org.osgi.service.cm.</em>;
  import aQute.bnd.annotation.component.<em>;
  import aQute.bnd.annotation.metatype.</em>;</p>

<p>@Component(properties=”service.pid=aQute.metatype.samples.Config”)
  public class Echo implements ManagedService {</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public void updated(Dictionary properties) 
  throws ConfigurationException {
  if ( properties != null ) {
    Config config = Configurable.createConfigurable(
      Config.class, properties);
    System.out.println(config.port());
  }
}   }
</code></pre></div></div>

<p>The editor can get quite rich with the metatype information. For example:</p>

<p>http://www.aqute.biz/uploads/Bnd/complex.png</p>

<p>This information came from the following Meta interface:</p>

<p>interface SampleConfig {
    String _secret();
    String $new();
    String name();
    enum X { A, B, C; }
    X x();
    int birthYear();
    URI uri();
    URI[] uris();
    Collection<URI> curis();
    Collection<Integer> ints(); // fails on webconsole
  }</Integer></URI></p>

<p>Though this is a big savings over normal fudging with properties, it gets better. The metatyping is fully integrated with DS. In this example, we’re using DS to register the Managed Service but this is not necessary because DS will automatically use the name of a component as the PID. So with a component life can be as easy as:</p>

<p>@Component(designate=Config.class)
  public class Echo2 {	
    @Activate
    void activate(Map<?,?> properties) throws ConfigurationException {
      Config config = Configurable.createConfigurable(
         Config.class, properties);
      System.out.println(config.port());
    }
  }</p>

<p>No more strings. Components and metatypes are extensively explained in [[Components]].</p>

			</div>
	</ul>

	
<nav class=next-prev>
	<a href='/releases/5.1.0/chapters/200-components.html'></a> <a href='/releases/5.1.0/chapters/220-contracts.html'></a>
</nav>
<footer class="container12" style="border-top: 1px solid black;padding:10px 0">
	<ul span=12 row>
		<li span=12>
			<ul>
				<li><a href="/releases/5.1.0/">GitHub</a>
			</ul>
	</ul>
</footer>

</body>
</html>
