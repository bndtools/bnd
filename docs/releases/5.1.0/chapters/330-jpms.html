<!DOCTYPE html>
<html lang="en" ng-app="jpm">

	<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="/releases/5.1.0/css/style.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="/js/releases.js"></script>
<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>JPMS Libraries</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="JPMS Libraries" />
<meta name="author" content="Raymond Augé" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Java developers face a challenge today of building JPMS libraries, let alone when adding a secondary goal that those libraries be usable OSGi bundles. Accuracy and consistency of metadata can often become a problem reducing the time spent focusing on more productive aspect of the library." />
<meta property="og:description" content="Java developers face a challenge today of building JPMS libraries, let alone when adding a secondary goal that those libraries be usable OSGi bundles. Accuracy and consistency of metadata can often become a problem reducing the time spent focusing on more productive aspect of the library." />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Raymond Augé"},"url":"/releases/5.1.0/chapters/330-jpms.html","headline":"JPMS Libraries","description":"Java developers face a challenge today of building JPMS libraries, let alone when adding a secondary goal that those libraries be usable OSGi bundles. Accuracy and consistency of metadata can often become a problem reducing the time spent focusing on more productive aspect of the library.","@type":"WebPage","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	
		<style>
			 body {
				counter-reset: h1 24;
			}
		</style>
	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

	

</head>


<body>

	
<ul class="container12 menu-bar">
	<li span=11><a class=menu-link href="/releases/5.1.0/"><img
			class=menu-logo src="/releases/5.1.0/img/bnd-80x40-white.png"></a>
			<a href="/releases/5.1.0/chapters/110-introduction.html">Intro
			</a><a href="/releases/5.1.0/chapters/800-headers.html">Headers
			</a><a href="/releases/5.1.0/chapters/825-instructions-ref.html">Instructions
			</a><a href="/releases/5.1.0/chapters/855-macros-ref.html">Macros
			</a><a href="/releases/5.1.0/chapters/400-commands.html">Commands
			</a><div class="releases"><button class="dropbtn">5.1.0</button><div class="dropdown-content"></div></div>
	<li class=menu-link span=1>
			<a href="https://github.com/bndtools/bnd" target="_"><img
	style="position:absolute;top:0;right:0;margin:0;padding:0;z-index:100"
	src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67"
	alt="Fork me on GitHub"
	data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>
</ul>


					

	<ul class=container12>
		<li span=3>
			<div>
			<ul class="side-nav">
	
		
			<li><a href="/releases/5.1.0/chapters/110-introduction.html">Introduction</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/120-install.html">How to install bnd</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/123-tour-workspace.html">Guided Tour</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/125-tour-features.html">Guided Tour Workspace & Projects</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/130-concepts.html">Concepts</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/140-best-practices.html">Best practices</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/150-build.html">Build</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/155-project-setup.html">Project Setup</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/160-jars.html">Generating JARs</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/170-versioning.html">Versioning</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/180-baselining.html">Baselining</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/200-components.html">Service Components</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/210-metatype.html">Metatype</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/220-contracts.html">Contracts</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/230-manifest-annotations.html">Bundle Annotations</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/235-accessor-properties.html">Accessor Properties</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/240-spi-annotations.html">SPI Annotations</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/250-resolving.html">Resolving Dependencies</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/300-launching.html">Launching</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/305-startlevels.html">Startlevels</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/310-testing.html">Testing</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/315-launchpad-testing.html">Testing with Launchpad</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/320-packaging.html">Packaging Applications</a>
	  	
  	
		
			<li class=selected>JPMS Libraries
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/390-wrapping.html">Wrapping Libraries to OSGi Bundles</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/395-generating-documentation.html">Generating Documentation</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/400-commands.html">Commands</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/600-developer.html">For Developers</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/650-windows.html">Tips for Windows users</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/700-tools.html">Tools bound to bnd</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/800-headers.html">Headers</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/820-instructions.html">Instruction Reference</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/825-instructions-ref.html">Instruction Index</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/850-macros.html">Macro Reference</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/855-macros-ref.html">Macro Index</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/870-plugins.html">Plugins</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/875-external-plugins.html">External Plugins</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/880-settings.html">Settings</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/900-errors.html">Errors</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/910-warnings.html">Warnings</a>
	  	
  	
		
			<li><a href="/releases/5.1.0/chapters/920-faq.html">Frequently Asked Questions</a>
	  	
  	
</ul>

			</div>
			
		<li span=9>
			<div class=notes-margin>
				<h1> JPMS Libraries</h1>
				<p>Java developers face a challenge today of building JPMS libraries, let alone when adding a secondary goal that those libraries be usable OSGi bundles. Accuracy and consistency of metadata can often become a problem reducing the time spent focusing on more productive aspect of the library.</p>

<p>A key <strong>OSGi</strong> innovation is the use of annotations to significantly reduce (in many cases to completely eliminate) the configuration needed to describe an OSGi bundle in build descriptors. See <a href="230-manifest-annotations.html">Bundle Annotations</a>.</p>

<h2 id="creating-jpms-libraries-with-bnd">Creating JPMS Libraries with bnd</h2>

<p>Just one of the additional benefits of using bnd is the ability to generate the <code class="highlighter-rouge">module-info.class</code>  along side all of the traditional OSGi metadata.</p>

<p>When applying the instruction <code class="highlighter-rouge">-jpms-module-info</code> bnd will collect any relevant information and using several heuristics automatically generates the <code class="highlighter-rouge">module-info.class</code>.</p>

<h3 id="name-version--access">Name, Version &amp; Access</h3>

<p>When calculating the <strong>module name</strong> the following is considered:</p>

<ol>
  <li>If the <code class="highlighter-rouge">-jpms-module-info</code> instruction contains a key, the key is used as the module name
e.g. <code class="highlighter-rouge">-jpms-module-info: foo.module</code>, the module name is <code class="highlighter-rouge">foo.module</code></li>
  <li>If the <code class="highlighter-rouge">Automatic-Module-Name</code> header is found in the manifest, the value is used as the module name</li>
  <li>Otherwise, the <code class="highlighter-rouge">Bundle-SymbolicName</code>  (as calculated) is used as the module name</li>
</ol>

<p>When calculating the <strong>module version</strong>, the following is considered:</p>

<ol>
  <li>If the <code class="highlighter-rouge">-jpms-module-info</code> instruction contains a key having a <code class="highlighter-rouge">version</code> attribute, the <code class="highlighter-rouge">version</code> attribute value is used as the module version
e.g. <code class="highlighter-rouge">-jpms-module-info: foo.module;version=1.2.3</code>, the module version is <code class="highlighter-rouge">1.2.3</code></li>
  <li>Otherwise, the <code class="highlighter-rouge">Bundle-Version</code>  (as calculated) is used as the module version</li>
</ol>

<p>When calculating the <strong>module access</strong>, the following is considered:</p>

<ol>
  <li>If the <code class="highlighter-rouge">-jpms-module-info</code> instruction contains a key having an <code class="highlighter-rouge">access</code> attribute, the <code class="highlighter-rouge">access</code> attribute value is used as the module access
e.g. <code class="highlighter-rouge">-jpms-module-info: foo.module;access=0x0020</code>, the module access is <code class="highlighter-rouge">0x0020</code> (OPEN)
<em>Legal values are:</em>
    <ol>
      <li><code class="highlighter-rouge">0x0020</code> (OPEN)</li>
      <li><code class="highlighter-rouge">0x1000</code> (SYNTHETIC)</li>
      <li><code class="highlighter-rouge">0x8000</code> (MANDATED)</li>
    </ol>
  </li>
  <li>If the header <code class="highlighter-rouge">Require-Capability</code> contains <strong>any</strong> capability in the <code class="highlighter-rouge">osgi.extender</code> namespace, the module access is <strong>open</strong></li>
  <li>Otherwise, module access is <code class="highlighter-rouge">0</code></li>
</ol>

<p><em>Note that for the above rules, the earliest matching rule wins.</em></p>

<h3 id="requires">Requires</h3>

<p>When calculating the module <strong>requires</strong> the following is considered:</p>

<ol>
  <li>
    <p>If the <code class="highlighter-rouge">-jpms-module-info</code> instruction contains a key having a <code class="highlighter-rouge">modules</code> attribute, the <code class="highlighter-rouge">modules</code> attribute value is first split on commas (<code class="highlighter-rouge">,</code>) and each segment is added as a raw required module name
e.g. <code class="highlighter-rouge">-jpms-module-info: foo.module;modules='java.desktop,java.logging'</code>, the modules <code class="highlighter-rouge">java.desktop</code>, and <code class="highlighter-rouge">java.logging</code> are added to module requires</p>
  </li>
  <li>
    <p>In addition, if the <code class="highlighter-rouge">-jpms-module-info</code> instruction contains a key having a <code class="highlighter-rouge">ee</code> attribute, the <code class="highlighter-rouge">ee</code> attribute indicates the Java module name mapping table to use for Java SE packages using bnd’s <code class="highlighter-rouge">aQute.bnd.build.model.EE</code> definitions which define a set of Java module name mapping tables keyed by <code class="highlighter-rouge">EE</code>.
e.g. <code class="highlighter-rouge">-jpms-module-info: foo.module;ee=JavaSE-10</code>, bnd will use the Java module name mapping table for Java SE 10 when determining module name for a given Java SE package</p>

    <p>If no <code class="highlighter-rouge">ee</code> attribute is specified, bnd will use the Java module name mapping table for Java SE 11 when determining module name for a given Java SE package</p>
  </li>
  <li>
    <p>If an imported package is associated with a module name, the module is added to module requires</p>

    <p><strong>Note:</strong> Non-Java SE packages are associated with module names by indexing all packages on the classpath of the bnd <code class="highlighter-rouge">analyzer</code> where the providing jar’s module’s name is:</p>

    <ul>
      <li>obtained from the jar’s <code class="highlighter-rouge">module-info.class</code></li>
      <li>or, obtained from the jar’s <code class="highlighter-rouge">Automatic-Module-Name</code></li>
      <li>or, calculated from the jar’s filename by stripping off any version suffix (beginning with the first occurrence of a dash followed by a digit <code class="highlighter-rouge">-\d</code>)</li>
      <li>otherwise, no module name is associated with the exported package</li>
    </ul>
  </li>
</ol>

<h4 id="requires---access-transitivity">Requires - Access: Transitivity</h4>

<p>Bnd will set the access to <code class="highlighter-rouge">transitive</code>  if <em>any</em> package exported by the bundle has a <code class="highlighter-rouge">uses</code> constraint on a package of the required module.</p>

<h4 id="requires----access-static">Requires  - Access: Static</h4>

<p>Bnd will set the access to <code class="highlighter-rouge">static</code> if the module is specified in the <code class="highlighter-rouge">-jpms-module-info</code> instruction and does not actual have any imports.</p>

<p>Bnd will set the access to <code class="highlighter-rouge">static</code> if <em>all</em> the packages imported from the module are any combination of <code class="highlighter-rouge">resolution:=optional</code>, <code class="highlighter-rouge">resolution:=dynamic</code> or match the <code class="highlighter-rouge">Dynamic-ImportPackage</code> instruction.</p>

<h4 id="requires---version">Requires - Version</h4>

<p>Bnd does not currently track a <code class="highlighter-rouge">require</code>’s version.</p>

<h3 id="exports">Exports</h3>

<p>Module <strong>exports</strong> will be mapped from all OSGi exported packages by default which can be managed easily with use of the <a href="230-manifest-annotations.html">Bundle Annotation</a> <code class="highlighter-rouge">@org.osgi.annotation.bundle.Export</code> on <code class="highlighter-rouge">package-info.java</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@org</span><span class="o">.</span><span class="na">osgi</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">bundle</span><span class="o">.</span><span class="na">Export</span>
<span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">acme</span><span class="o">.</span><span class="na">foo</span><span class="o">;</span>
</code></pre></div></div>

<p><strong>Targeted exports</strong> (via the <code class="highlighter-rouge">exports .. to ..</code> clause) are supported with use of the <code class="highlighter-rouge">@aQute.bnd.annotation.jpms.ExportTo</code>. This annotation specifies the module name(s) to which a exported is targeted.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@org</span><span class="o">.</span><span class="na">osgi</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">bundle</span><span class="o">.</span><span class="na">Export</span>
<span class="nd">@aQute</span><span class="o">.</span><span class="na">bnd</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">jpms</span><span class="o">.</span><span class="na">ExportTo</span><span class="o">(</span><span class="s">"com.acme.bar"</span><span class="o">)</span>
<span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">acme</span><span class="o">.</span><span class="na">foo</span><span class="o">;</span>
</code></pre></div></div>

<p><strong>Note:</strong> The <code class="highlighter-rouge">@ExportTo</code> annotation is only relevant in conjunction with the <code class="highlighter-rouge">@Export</code> annotation.</p>

<h3 id="opens">Opens</h3>

<p>Module <strong>opens</strong> are supported with use of the <code class="highlighter-rouge">@aQute.bnd.annotation.jpms.Open</code> annotation on <code class="highlighter-rouge">package-info.java</code>. This annotation optionally specifies the module name(s) to which the opens is targeted.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@aQute</span><span class="o">.</span><span class="na">bnd</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">jpms</span><span class="o">.</span><span class="na">Open</span>
<span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">acme</span><span class="o">.</span><span class="na">foo</span><span class="o">;</span>
</code></pre></div></div>

<h3 id="uses">Uses</h3>

<p>Module <strong>uses</strong> are supported transparently with use of the bnd <a href="240-spi-annotations.html#serviceconsumer"><code class="highlighter-rouge">@aQute.bnd.annotation.spi.ServiceConsumer</code> SPI Annotation</a>.</p>

<h3 id="provides">Provides</h3>

<p>Module <strong>provides</strong> are supported transparently with use of the bnd <a href="240-spi-annotations.html#serviceprovider"><code class="highlighter-rouge">@aQute.bnd.annotation.spi.ServiceProvider</code> SPI Annotation</a>.</p>

<h3 id="main-class">Main-Class</h3>

<p>The module main class attribute is supported with use of the <code class="highlighter-rouge">@aQute.bnd.annotation.jpms.MainClass</code> annotation applied to the main class’s Java type.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@aQute</span><span class="o">.</span><span class="na">bnd</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">jpms</span><span class="o">.</span><span class="na">MainClass</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{...}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="java-8-support">Java 8 Support</h3>

<p>Bnd’s <code class="highlighter-rouge">module-info.class</code> generation is supported when building with Java 8 or higher. (Yes! I did say Java 8.)</p>

<h2 id="advanced-options">Advanced Options</h2>

<p>There are scenarios where the heuristics used by bnd don’t give the desired result because the necessary information is not available or is incorrect.</p>

<p>The <code class="highlighter-rouge">-jpms-module-info-options</code> instruction provides some capabilities to help the developer handle these scenarios. The instruction uses the <em>package header syntax</em> similar to many other bnd instructions. The keys of these instructions are module names and there are 4 available attributes. They are:</p>

<ul>
  <li>
    <p><strong><code class="highlighter-rouge">substitute</code></strong> - If bnd generates a module name matching the value of this attribute it should be substituted with the key of the instruction.
e.g.</p>

    <div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">-jpms-module-info-options</span><span class="p">:</span> <span class="s">java.enterprise;substitute="geronimo-jcdi_2.0_spec"</span>
</code></pre></div>    </div>
    <p>means that if bnd calculates the module name to be <code class="highlighter-rouge">geronimo-jcdi_2.0_spec</code> it should replace it with <code class="highlighter-rouge">java.enterprise</code></p>
  </li>
  <li>
    <p><strong><code class="highlighter-rouge">ignore</code></strong> - If the attribute <code class="highlighter-rouge">ignore="true"</code> is found the require matching the key of the instruction will not be added.
e.g.</p>

    <div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">-jpms-module-info-options</span><span class="p">:</span> <span class="s">java.enterprise;ignore="true"</span>
</code></pre></div>    </div>

    <p>means ignore the module <code class="highlighter-rouge">java.enterprise</code></p>
  </li>
  <li>
    <p><strong><code class="highlighter-rouge">static</code></strong> - If the attribute <code class="highlighter-rouge">static="true|false"</code> is found the access of the module matching the key of the instruction will be set to match.
e.g.</p>

    <div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">-jpms-module-info-options</span><span class="p">:</span> <span class="s">java.enterprise;static="true"</span>
</code></pre></div>    </div>

    <p>means make the <code class="highlighter-rouge">require</code> for module <code class="highlighter-rouge">java.enterprise</code> <code class="highlighter-rouge">static</code></p>
  </li>
  <li>
    <p><strong><code class="highlighter-rouge">transitive</code></strong> - If the attribute <code class="highlighter-rouge">transitive="true|false"</code> is found the access of the module matching the key of the instruction will be set to match.
e.g.</p>

    <div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">-jpms-module-info-options</span><span class="p">:</span> <span class="s">java.enterprise;transitive="true"</span>
</code></pre></div>    </div>

    <p>means make the <code class="highlighter-rouge">require</code> for module <code class="highlighter-rouge">java.enterprise</code> <code class="highlighter-rouge">transitive</code></p>
  </li>
</ul>

<p>The following is an example with multiple attributes and instructions:</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">-jpms-module-info-options</span><span class="p">:</span> <span class="se">\
</span>    <span class="s">java.enterprise;substitute="geronimo-jcdi_2.0_spec";static=true;transitive=true,</span><span class="se">\
</span>    <span class="s">java.management;ignore=true;</span>
</code></pre></div></div>


			</div>
	</ul>

	
<nav class=next-prev>
	<a href='/releases/5.1.0/chapters/320-packaging.html'></a> <a href='/releases/5.1.0/chapters/390-wrapping.html'></a>
</nav>
<footer class="container12" style="border-top: 1px solid black;padding:10px 0">
	<ul span=12 row>
		<li span=12>
			<ul>
				<li><a href="/releases/5.1.0/">GitHub</a>
			</ul>
	</ul>
</footer>

</body>
</html>
