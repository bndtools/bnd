# Bndtools Repository View - Eclipse P2 Feature Support

## Objective
Enhance the bndtools repository view to display Eclipse P2 features as synthetic/virtual entries with hierarchical structure.

## Implementation Status

### âœ… Completed

#### Model Classes (bndtools.core/src/bndtools/model/repo/)
- [x] **RepositoryFeature.java** - Main feature node extending RepositoryEntry, implements Actionable
  - Wraps aQute.p2.api.Feature
  - Provides title(), tooltip(), actions() methods
  - Exposes included features, required features, and included bundles
  
- [x] **FeatureFolderNode.java** - Virtual folder node for grouping feature children
  - Three folder types: INCLUDED_FEATURES, REQUIRED_FEATURES, INCLUDED_BUNDLES
  - Each folder contains wrapped items as children
  
- [x] **IncludedFeatureItem.java** - Wrapper for Feature.IncludedFeature
  - Displays: id, version, optional flag, platform filters (os/ws/arch)
  
- [x] **RequiredFeatureItem.java** - Wrapper for Feature.RequiredFeature
  - Displays: id, version, match rule, optional flag
  
- [x] **IncludedBundleItem.java** - Wrapper for Feature.Plugin
  - Displays: id, version, platform filters (os/ws/arch), fragment flag, unpack flag

#### Content Provider (RepositoryTreeContentProvider.java)
- [x] Enhanced `getChildren()` to handle RepositoryFeature and FeatureFolderNode
  - **CRITICAL**: RepositoryFeature check MUST come before RepositoryBundle check (both extend RepositoryEntry)
- [x] Implemented `getFeatureChildren()` to build feature hierarchy with 3 folder nodes
- [x] Enhanced `getParent()` to track parent relationships for all feature classes
- [x] Enhanced `hasChildren()` to recognize RepositoryFeature and FeatureFolderNode
- [x] Enhanced `getRepositoryBundles()` to fetch features from P2 repositories (FeatureProvider)
  - **CRITICAL**: Features are collected FIRST and their IDs tracked in a Set
  - Bundle creation loop excludes feature IDs to prevent duplicates
  - This prevents features from being wrapped as RepositoryBundle objects

#### Repositories View (RepositoriesView.java)
- [x] Enhanced `getRepositoryPlugin()` helper method to handle RepositoryFeature
  - **CRITICAL**: RepositoryFeature check MUST come before RepositoryBundle check (both extend RepositoryEntry)
- [x] Added import for RepositoryFeature class

#### Label Provider (RepositoryTreeLabelProvider.java)
- [x] Added display logic for RepositoryFeature with repository qualifier
  - **CRITICAL**: RepositoryFeature check MUST come before RepositoryBundle check (both extend RepositoryEntry)
- [x] Added display logic for FeatureFolderNode with folder icon
- [x] Added display logic for IncludedFeatureItem with feature icon
- [x] Added display logic for RequiredFeatureItem with feature icon
- [x] Added display logic for IncludedBundleItem with bundle icon
- [x] Enhanced `getText()` for all feature classes with exception handling
- [x] Tooltip support via Actionable interface (description fallback to id+version)

#### Drag-and-Drop Support (SelectionDragAdapter.java, RepositoryBundleSelectionPart.java)
- [x] Enhanced `SelectionDragAdapter.dragSetData()` to handle RepositoryFeature
  - Creates drag data as "feature:id:version" string
- [x] Enhanced `RepositoryBundleSelectionPart.selectionIsDroppable()` to accept RepositoryFeature
- [x] Enhanced `RepositoryBundleSelectionPart.handleSelectionDrop()` to process features
  - Creates VersionedClause with "feature:id" BSN
  - Adds "feature=true" attribute for resolver identification
  - Preserves version information

#### Icon Configuration (icons.properties)
- [x] Added `icons.feature=icons/plugin.png` mapping (using Eclipse plugin icon)
- [x] Added `icons.fldr_obj=$IMG_OBJS_FOLDER` mapping for Eclipse standard folder icon
- [x] Icons verified present in built JAR

#### P2 Repository Integration (P2Repository.java)
- [x] Implemented FeatureProvider interface in P2Repository class
- [x] Added `getFeatures()` method delegating to P2Indexer
- [x] Added `getFeature(id, version)` method delegating to P2Indexer
- [x] Created FeatureProvider interface in biz.aQute.bndlib

#### P2Indexer Enhancement (P2Indexer.java)
- [x] Implemented `getFeatures()` method to extract features from indexed resources
  - Queries repository for all resources with `type=eclipse.feature` in identity capability
  - Downloads and parses feature JAR files to create Feature objects
  - Returns list of parsed features
- [x] Implemented `getFeature(id, version)` method for single feature lookup
- [x] Added `extractFeatureFromResource()` helper to download and extract features from resources
  - Handles pack.gz compressed features using Unpack200 processor
  - Gracefully skips non-JAR artifacts (e.g., .content files)
- [x] Added `parseFeatureFromJar()` helper to parse feature.xml from feature JAR files
  - Validates file format before attempting to parse
  - Uses debug-level logging to avoid cluttering logs with expected failures
  - Skips non-JAR files and files without feature.xml
- [x] Features are automatically indexed during P2 repository processing (via `processArtifact()` in P2Indexer)
- [x] Feature resources include identity capability with `type=eclipse.feature`

#### FeatureFolderNode Enhancement
- [x] Added `feature.parse()` call to ensure feature data is loaded before displaying children
- [x] Gracefully handles parse errors by showing empty folders

### ğŸš§ Pending

#### Feature Resolution (Future Enhancement)
- [ ] Implement feature expansion logic during bndrun resolution
- [ ] Recursively collect bundles from included features
- [ ] Handle optional features and bundles appropriately
- [ ] Support platform filters (os/ws/arch) in bundle selection
- [ ] Consider match rules for required features

#### Testing
- [ ] Manual testing in Eclipse with P2 repositories
- [ ] Test feature hierarchy display
- [ ] Test drag-and-drop to bndrun files
- [ ] Test feature resolution during resolve operation (once implemented)
- [ ] Test platform filter evaluation (once implemented)

## Feature Display Structure

```
ğŸ“¦ P2 Repository
  â”œâ”€â”€ ğŸ“¦ bundle.a (1.0.0)
  â”œâ”€â”€ ğŸ“¦ bundle.b (2.0.0)
  â”œâ”€â”€ â­ feature.example (1.0.0)
  â”‚   â”œâ”€â”€ ğŸ“ Included Features
  â”‚   â”‚   â””â”€â”€ â­ feature.base 1.0.0
  â”‚   â”œâ”€â”€ ğŸ“ Required Features
  â”‚   â”‚   â””â”€â”€ â­ feature.core 1.0.0 [compatible]
  â”‚   â””â”€â”€ ğŸ“ Included Bundles
  â”‚       â”œâ”€â”€ ğŸ“¦ org.example.plugin 1.0.0
  â”‚       â””â”€â”€ ğŸ“¦ org.example.ui 1.0.0 [linux/gtk/x86_64]
```

## Design Notes

### Feature as Macro-like Entry
Features should be treated similarly to macros:
- Appear in repository view as expandable synthetic entries
- When dragged to bndrun, the feature reference is added (not individual bundles)
- During resolution, the feature is expanded to its constituent bundles
- Recursive expansion for included features

### Platform Filtering
Bundles and features may specify platform constraints (os/ws/arch):
- Display platform filters in labels (e.g., "[linux/gtk/x86_64]")
- Apply filters during resolution based on target environment
- Only include matching bundles in final resolution

### Optional Dependencies
Both features and bundles can be marked as optional:
- Display optional flag in labels (e.g., "optional")
- During resolution, optional items may be skipped if not available
- Required items must be present for successful resolution